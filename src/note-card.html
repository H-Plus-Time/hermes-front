<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/polymer/lib/mixins/gesture-event-listeners.html">

<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">

<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<dom-module id="note-card">
    <template>
        <style>
            :host {
                display:block;
                width:640px;
            }
            canvas {
                background:lightgrey;
            }
            paper-icon-button[icon=edit] {
                border-radius:50%;
            }
            div[edit-bar] {
                display:flex;
                flex-direction:row;
                justify-content: space-between;
            }
        </style>
        <paper-input required auto-validate
            label="Title" value="{{title}}"></paper-input>
        <div edit-bar>
            <div>
                <paper-icon-button icon="clear" on-tap="clear"></paper-icon-button>
                <paper-icon-button icon="save"
                    disabled="[[!submittable]]"
                    on-tap="fireSave"></paper-icon-button>
            </div>
            <div id="palette">
                <template is="dom-repeat" items="[[colors]]">
                    <paper-icon-button name="[[item]]"
                        icon="edit"
                        style$="background:[[item]]"
                        on-tap="setColor"></paper-icon-button>
                </template>
            </div>

        </div>
        <canvas width="640" height="480"
            on-track="handleTracking"
            on-up="handleUp"
            on-down="handleDown">
        </canvas>
    </template>
    <script>
        class NoteCard extends Polymer.GestureEventListeners(Polymer.Element) {
            static get is() { return 'note-card'; }

            static get properties() {
                return {
                    lastX: Number,
                    lastY: Number,
                    lastFrame: ImageData,
                    title: {
                        type: String,
                        value: () => ''
                    },
                    submittable: {
                        type: Boolean,
                        notify: true,
                        computed: 'computeSubmittable(title)'
                    },
                    inkColor: {
                        type: Object,
                        value: () => Color("black")
                    },
                    colors: {
                        type: Array,
                        value: [
                            "purple",
                            "black",
                            "blue",
                            "darkred"
                        ]
                    }
                }
            }
            computeSubmittable(title) {
                if(title.length == 0) {
                    return false;
                } else {
                    return true;
                }
            }
            drawPoint(ctx, width, height, x,y, color) {
                let idx = (width*y + x)*4;
                let canvasData = ctx.getImageData(0,0, width, height)
                canvasData.data[idx] = color.red;
                canvasData.data[idx+1] = color.green;
                canvasData.data[idx+2] = color.blue;
                canvasData.data[idx+3] = color.alpha;
                ctx.putImageData(canvasData, 0, 0);
            }

            inRange(x, min, max) {
                return x >= min && x <= max;
            }

            handleDown(e) {
                e.preventDefault();
                this.lastFrame = null;
                this.lastX = null;
                this.lastY = null;
                this.handleTracking(e);
            }

            handleUp(e) {
                e.preventDefault();
                this.lastFrame = null;
                this.lastX = null;
                this.lastY = null;
                let cvs = this.shadowRoot.querySelector('canvas');
                let ctx = cvs.getContext('2d');
                this.lastFrame = ctx.getImageData(0,0,cvs.width, cvs.height);
                this.handleTracking(e);
            }

            handleTracking(e) {
                e.preventDefault();
                let cvs = this.shadowRoot.querySelector('canvas');
                let ctx = cvs.getContext('2d');
                let boundingBox = cvs.getBoundingClientRect()
                let cvsOffsetX = boundingBox.left;
                let cvsOffsetY = boundingBox.top;
                let offsetX = Math.round(e.detail.x)-cvsOffsetX;
                let offsetY = Math.round(e.detail.y)-cvsOffsetY;
                if(!this.inRange(offsetX, 0, cvs.width)) {
                    return
                }

                if(!this.inRange(offsetY, 0, cvs.height)) {
                    return
                }
                if(e.type === "down") {
                    console.log("paint it red")
                    this.drawPoint(ctx, cvs.width, cvs.height, offsetX, offsetY,Color("red"));
                } else {
                    this.drawPoint(ctx, cvs.width, cvs.height, offsetX, offsetY,this.inkColor);

                }
                if(this.lastX && this.lastY) {
                    ctx.strokeStyle = this.inkColor.toCSSHex();
                    ctx.beginPath();
                    ctx.moveTo(this.lastX, this.lastY);
                    ctx.lineTo(offsetX, offsetY);
                    ctx.stroke();
                }
                this.lastX = offsetX;   
                this.lastY = offsetY;   
            }
            clear() {
                let cvs = this.shadowRoot.querySelector('canvas');
                let ctx = cvs.getContext('2d');
                this.lastFrame = null;
                this.lastX = null;
                this.lastY = null;
                ctx.clearRect(0,0, cvs.width, cvs.height);
            }
            fireSave(e) {
                let cvs = this.shadowRoot.querySelector('canvas');
                let ctx = cvs.getContext('2d');
                let frame = cvs.toDataURL('image/jpeg', 1.0);
                this.clear();
                this.dispatchEvent(new CustomEvent('save-note',
                    {detail: {frame: frame, title: this.title},
                    bubbles: true, composed: true}))
            }

            setColor(e) {
                let color = e.target.name;
                this.set('inkColor', Color(color));
            }

        }
        window.customElements.define(NoteCard.is, NoteCard)
    </script>
</dom-module>